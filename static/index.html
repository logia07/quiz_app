<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ê–Ω–∫–µ—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <script src="https://unpkg.com/@vkontakte/vk-bridge@2.12.0/dist/vk-bridge.umd.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      font-family: sans-serif;
      background: #f9f9f9;
      overflow-x: hidden;
      overflow-y: hidden;
      width: 100%;
      height: 100%;
      position: fixed;
    }
    .screen {
      display: none;
      width: 100%;
      height: 100%;
      min-height: -webkit-fill-available;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
    }
    .active { display: block; }

    /* === –ê–î–ê–ü–¢–ò–í–ù–´–ï –ö–û–ù–¢–ï–ô–ù–ï–†–´ === */
    .quiz-container {
      position: relative;
      width: 100%;
      max-width: 1080px;
      aspect-ratio: 1080 / 1920;
      margin: 0 auto;
    }

    .prefull-container {
      position: relative;
      width: 100%;
      max-width: 1080px;
      aspect-ratio: 1080 / 2624;
      margin: 0 auto;
    }

    .result-container {
      position: relative;
      width: 100%;
      max-width: 1080px;
      aspect-ratio: 1080 / 4830;
      margin: 0 auto;
    }

    .illustration {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    @font-face {
      font-family: 'InputFont';
      src: url('/static/fonts/Blogger_Sans-Light_Italic.otf') format('opentype');
      font-display: swap;
    }
    @font-face {
      font-family: 'BloggerSans';
      src: url('/static/fonts/Blogger_Sans-Light.otf') format('opentype');
      font-display: swap;
    }

    /* === –ê–î–ê–ü–¢–ò–í–ù–´–ï –ü–û–ó–ò–¶–ò–ò (1080√ó1920) === */
    .input-field {
      position: absolute;
      left: 16.2%;
      top: 38.8%;
      width: 69.4%;
      height: 134px;
      padding: 0 10px 0 0px;
      font-family: 'InputFont', cursive;
      font-size: clamp(12px, 3.5vmin, 35px);
      color: #555;
      text-align: left;
      border: none;
      outline: none;
      background: transparent;
      border-radius: 12px;
      resize: none;
      overflow: hidden;
      z-index: 15;
      line-height: 1.5;
      word-break: break-word;
      white-space: pre-wrap;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .char-counter {
      position: absolute;
      top: 36.8%;
      right: 14.4%;
      font-family: 'SF Pro Text', sans-serif;
      font-size: clamp(10px, 2vmin, 12px);
      color: rgba(51, 51, 51, 0.5);
      z-index: 16;
    }

    .action-btn {
      position: absolute;
      left: 4.2%;
      width: 91.7%;
      aspect-ratio: 990 / 171;
      min-height: 50px;
      max-height: 171px;
      border-radius: 76px;
      font-family: 'BloggerSans', sans-serif;
      font-size: clamp(18px, 4vw, 71px);
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      border: none;
      outline: none;
      background: transparent;
      text-align: center;
      padding: 0 20px;
      box-shadow: 0 8px 8px rgba(0, 0, 0, 0.25);
      z-index: 20;
      touch-action: manipulation;
    }

    .action-btn:active {
      transform: translateY(4px) scale(0.985);
      opacity: 0.92;
      box-shadow: 0 4px 4px rgba(0, 0, 0, 0.2);
    }

    #welcome .action-btn { bottom: 7.0%; background: linear-gradient(135deg, #93AE00, #C7DD4C); color: #FFFFFF; }
    #q1 .action-btn { bottom: 7.0%; background: linear-gradient(135deg, #FD5DA2, #CD2F61); color: #FFFFFF; }
    #q2-prev, #q3-prev, #q4-prev, #q5-prev, #q6-prev, #q7-prev, #q8-prev {
      bottom: 7.0%; background: #FFFFFF; color: #52524F; box-shadow: none;
    }
    #q2-next, #q3-next, #q4-next, #q5-next, #q6-next, #q7-next, #q8-next {
      bottom: 17.6%; background: linear-gradient(135deg, #BAA0F3, #6E47C5); color: #FFFFFF;
    }
    #q3-next { background: linear-gradient(135deg, #93AE00, #C7DD4C); }
    #q4-next { background: linear-gradient(135deg, #FD5DA2, #CD2F61); }
    #q5-next { background: linear-gradient(135deg, #BAA0F3, #6E47C5); }
    #q6-next { background: linear-gradient(135deg, #93AE00, #C7DD4C); }
    #q7-next { background: linear-gradient(135deg, #FD5DA2, #CD2F61); }
    #q8-next { background: linear-gradient(135deg, #BAA0F3, #6E47C5); }

    #prefull-btn {
      position: absolute;
      left: 4.2%;
      width: 91.7%;
      aspect-ratio: 990 / 171;
      min-height: 50px;
      max-height: 171px;
      bottom: 7.6%;
      border-radius: 76px;
      font-family: 'BloggerSans', sans-serif;
      font-size: clamp(18px, 4vw, 71px);
      background: linear-gradient(135deg, #FD5DA2, #CD2F61);
      color: #FFFFFF;
      cursor: pointer;
      box-shadow: 0 8px 8px rgba(0, 0, 0, 0.25);
      display: flex;
      justify-content: center;
      align-items: center;
      border: none;
      outline: none;
      text-align: center;
      padding: 0 20px;
    }

    #result-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 16px;
    }

    #share-btn {
      position: absolute;
      left: 4.2%;
      width: 91.7%;
      aspect-ratio: 990 / 171;
      min-height: 50px;
      max-height: 171px;
      bottom: 6.8%;
      border-radius: 76px;
      font-family: 'BloggerSans', sans-serif;
      font-size: clamp(18px, 4vw, 71px);
      background: linear-gradient(135deg, #FD5DA2, #CD2F61);
      color: #FFFFFF;
      cursor: pointer;
      box-shadow: 0 8px 8px rgba(0, 0, 0, 0.25);
      border: none;
      outline: none;
      text-align: center;
      padding: 0 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 30;
    }
  </style>
</head>
<body>
  <div id="welcome" class="screen active">
    <div class="quiz-container">
      <img src="/static/images/welcome.jpg" class="illustration">
      <button class="action-btn" id="start-btn">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É</button>
    </div>
  </div>

  <div id="q1" class="screen">
    <div class="quiz-container">
      <img src="/static/images/q1.jpg" class="illustration">
      <div id="name" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="name-counter">0/70</div>
      <button class="action-btn" id="q1-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q2" class="screen">
    <div class="quiz-container">
      <img src="/static/images/q2.jpg" class="illustration">
      <div id="city" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="city-counter">0/70</div>
      <button class="action-btn" id="q2-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q2-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q3" class="screen">
    <div class="quiz-container">
      <img src="/static/images/q3.jpg" class="illustration">
      <div id="dream" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="dream-counter">0/70</div>
      <button class="action-btn" id="q3-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q3-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q4" class="screen">
    <div class="quiz-container">
      <img src="/static/images/q4.jpg" class="illustration">
      <div id="age" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="age-counter">0/70</div>
      <button class="action-btn" id="q4-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q4-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q5" class="screen">
    <div class="quiz-container">
      <img src="/static/images/q5.jpg" class="illustration">
      <div id="hobby" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="hobby-counter">0/70</div>
      <button class="action-btn" id="q5-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q5-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q6" class="screen">
    <div class="quiz-container">
      <img src="/static/images/q6.jpg" class="illustration">
      <div id="goal" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="goal-counter">0/70</div>
      <button class="action-btn" id="q6-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q6-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q7" class="screen">
    <div class="quiz-container">
      <img src="/static/images/q7.jpg" class="illustration">
      <div id="quote" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="quote-counter">0/70</div>
      <button class="action-btn" id="q7-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q7-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q8" class="screen">
    <div class="quiz-container">
      <img src="/static/images/q8.jpg" class="illustration">
      <div id="extra" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="extra-counter">0/70</div>
      <button class="action-btn" id="q8-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q8-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="prefull" class="screen">
    <div class="prefull-container">
      <img src="/static/images/prefull.jpg" class="illustration">
      <button class="action-btn" id="prefull-btn">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
    </div>
  </div>

  <div id="result-screen" class="screen">
    <div class="result-container">
      <img id="result-img">
      <button class="action-btn" id="share-btn">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –ø–æ–¥—Ä—É–∂–∫–∞–º–∏!</button>
    </div>
  </div>

  <script>
    let currentScreen = 'welcome';
    let userId = null;
    let platform = 'web';
    const TELEGRAM_BOT_NAME = "Sloboda8Marta_bot";
    const MAX_LEN = 70; /* ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û: 70 –≤–º–µ—Å—Ç–æ 76 */
    const MAX_LINES = 2;
    const MAX_CHARS_LINE_1 = 33;
    const MAX_CHARS_LINE_2_IF_30_PLUS = 40;

    if (window.location.search.includes('vk_app_id')) {
      platform = 'vk';
      vkBridge.send('VKWebAppInit').catch(console.error);
      vkBridge.send('VKWebAppGetUserInfo')
        .then(data => userId = data.id)
        .catch(console.error);
    } else if (window.Telegram?.WebApp) {
      platform = 'telegram';
      const initData = Telegram.WebApp.initDataUnsafe;
      userId = initData?.user?.id;
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }

    function getText(el) { return el?.innerText || ''; }
    function setText(el, text) { if (el) el.innerText = text; }
    function countLines(text) { return text.split('\n').length; }

    const STORAGE_KEY = 'quiz_answers_v15';
    function saveAnswer(field, value) {
      const current = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      current[field] = value;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(current));
    }

    function loadAnswers() {
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      ['name','city','dream','age','hobby','goal','quote','extra'].forEach(id => {
        const el = document.getElementById(id);
        const counter = document.getElementById(`${id}-counter`);
        if (el && saved[id]) {
          setText(el, saved[id]);
          counter.textContent = `${saved[id].length}/${MAX_LEN}`;
        }
      });
    }

    function clearAnswers() {
      localStorage.removeItem(STORAGE_KEY);
    }

    // === –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ‚Äî Enter —Ä–∞–±–æ—Ç–∞–µ—Ç 1 —Ä–∞–∑, 70 —Å–∏–º–≤–æ–ª–æ–≤ –≤—Å–µ–≥–æ ===
    function setupInputLimit(div, counterId, maxLen = MAX_LEN) {
      div.addEventListener('keydown', (e) => {
        const isSpecialKey = ['Backspace','Delete','ArrowLeft','ArrowRight',
          'ArrowUp','ArrowDown','Tab','Escape',
          'Control','Meta','Alt'].includes(e.key);

        if (isSpecialKey) return;

        const text = getText(div);
        const lines = countLines(text);

        // Enter —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ (–ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ 2 —Å—Ç—Ä–æ–∫—É)
        if (e.key === 'Enter') {
          if (lines >= MAX_LINES) {
            e.preventDefault();
            return false;
          }
          return;
        }

        if (text.length >= maxLen) {
          e.preventDefault();
          return false;
        }
      });

      div.addEventListener('input', () => {
        const text = getText(div);
        const counter = document.getElementById(counterId);
        const lines = text.split('\n');

        if (lines.length >= 1 && lines[0].length > MAX_CHARS_LINE_1) {
          lines[0] = lines[0].slice(0, MAX_CHARS_LINE_1);
        }

        const maxLine2 = lines.length > 0 && lines[0].length >= 30
          ? MAX_CHARS_LINE_2_IF_30_PLUS
          : MAX_CHARS_LINE_1;

        if (lines.length >= 2 && lines[1].length > maxLine2) {
          lines[1] = lines[1].slice(0, maxLine2);
        }

        if (lines.length > MAX_LINES) {
          const trimmed = lines.slice(0, MAX_LINES).join('\n');
          setText(div, trimmed);
          if (counter) counter.textContent = `${trimmed.length}/${maxLen}`;
          saveAnswer(div.id, trimmed);
          return;
        }

        const joinedText = lines.join('\n');
        if (joinedText.length > maxLen) {
          const trimmed = joinedText.slice(0, maxLen);
          setText(div, trimmed);
          if (counter) counter.textContent = `${maxLen}/${maxLen}`;
          saveAnswer(div.id, trimmed);
          return;
        }

        if (counter) counter.textContent = `${text.length}/${maxLen}`;
        saveAnswer(div.id, text);
      });
    }

    /* === –ê–î–ê–ü–¢–ò–í–ù–´–ô –®–†–ò–§–¢ + 5px –û–¢–°–¢–£–ü –î–õ–Ø 2 –°–¢–†–û–ö–ò === */
    function updateInputFontSizes() {
      const containers = document.querySelectorAll('.quiz-container, .prefull-container, .result-container');
      containers.forEach(container => {
        const containerWidth = container.offsetWidth;
        if (!containerWidth) return;

        const scaleFactor = containerWidth / 1080;

        container.querySelectorAll('.input-field').forEach(field => {
          const baseSize = 35;
          const newSize = baseSize * scaleFactor;
          const finalSize = Math.max(11, Math.min(35, newSize));
          field.style.fontSize = `${finalSize}px`;

          const additionalLineHeight = 5 / finalSize;
          const finalLineHeight = 1.5 + additionalLineHeight;
          field.style.lineHeight = `${finalLineHeight}`;

          const paddingTop = 5 * scaleFactor;
          field.style.paddingTop = `${paddingTop}px`;
        });

        container.querySelectorAll('.char-counter').forEach(counter => {
          const baseSize = 12;
          const newSize = baseSize * scaleFactor;
          const finalSize = Math.max(9, Math.min(12, newSize));
          counter.style.fontSize = `${finalSize}px`;
        });

        container.querySelectorAll('.action-btn').forEach(btn => {
          const baseSize = 71;
          const newSize = baseSize * scaleFactor;
          const finalSize = Math.max(16, Math.min(71, newSize));
          btn.style.fontSize = `${finalSize}px`;
        });
      });
    }

    /* === –í—ã–∑—ã–≤–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ —ç–∫—Ä–∞–Ω–∞ === */
    function show(screenId) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      currentScreen = screenId;
      setTimeout(updateInputFontSizes, 50);
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadAnswers();

      ['name','city','dream','age','hobby','goal','quote','extra'].forEach(id => {
        const el = document.getElementById(id);
        if (el) setupInputLimit(el, `${id}-counter`, MAX_LEN);
      });

      setTimeout(updateInputFontSizes, 150);
      window.addEventListener('resize', updateInputFontSizes);

      document.getElementById('start-btn').onclick = () => show('q1');
      document.getElementById('q1-next').onclick = () => show('q2');
      document.getElementById('q2-prev').onclick = () => show('q1');
      document.getElementById('q2-next').onclick = () => show('q3');
      document.getElementById('q3-prev').onclick = () => show('q2');
      document.getElementById('q3-next').onclick = () => show('q4');
      document.getElementById('q4-prev').onclick = () => show('q3');
      document.getElementById('q4-next').onclick = () => show('q5');
      document.getElementById('q5-prev').onclick = () => show('q4');
      document.getElementById('q5-next').onclick = () => show('q6');
      document.getElementById('q6-prev').onclick = () => show('q5');
      document.getElementById('q6-next').onclick = () => show('q7');
      document.getElementById('q7-prev').onclick = () => show('q6');
      document.getElementById('q7-next').onclick = () => show('q8');
      document.getElementById('q8-prev').onclick = () => show('q7');
      document.getElementById('q8-next').onclick = () => show('prefull');
      document.getElementById('prefull-btn').onclick = () => submitForm();
      document.getElementById('share-btn').onclick = () => shareResult();

      if (platform === 'telegram' && window.Telegram?.WebApp) {
        setTimeout(() => Telegram.WebApp.expand(), 300);
      }

      show('welcome');
    });

    function show(screenId) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      currentScreen = screenId;
    }

    async function submitForm() {
      const btn = document.getElementById('prefull-btn');
      if (!btn) return;
      const originalText = btn.textContent.trim();
      btn.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%"><span>${originalText}</span><span style="display:inline-block;width:48px;height:48px;border:4px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:26px"></span></div>`;
      btn.style.pointerEvents = 'none';

      try {
        const answers = {
          name: getText(document.getElementById('name')) || '',
          city: getText(document.getElementById('city')) || '',
          dream: getText(document.getElementById('dream')) || '',
          age: getText(document.getElementById('age')) || '',
          hobby: getText(document.getElementById('hobby')) || '',
          goal: getText(document.getElementById('goal')) || '',
          quote: getText(document.getElementById('quote')) || '',
          extra: getText(document.getElementById('extra')) || ''
        };

        const res = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId, platform, answers })
        });

        if (!res.ok) throw new Error('Server error');

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        document.getElementById('result-img').src = url;
        show('result-screen');
        clearAnswers();
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞:", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
        btn.innerHTML = originalText;
        btn.style.pointerEvents = 'auto';
      }
    }

    function shareResult() {
      if (platform === 'telegram') {
        // üî¥ TELEGRAM: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –±–æ—Ç —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–∞—Ä—Ç–∏–Ω–∫—É
        Telegram.WebApp.showAlert(
          "–†–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –≤ —á–∞—Ç–µ —Å –±–æ—Ç–æ–º! –ü–æ–¥–µ–ª–∏—Å—å —Å –ø–æ–¥—Ä—É–∂–∫–∞–º–∏ –∏ —É—á–∞—Å—Ç–≤—É–π –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ –ø—Ä–∏–∑–æ–≤!"
        );
      } else if (platform === 'vk') {
        // üî¥ VK: –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ—Å—Ç–∞ –Ω–∞ —Å—Ç–µ–Ω–µ
        const message = "–ó–∞–ø–æ–ª–Ω–∏ –∞–Ω–∫–µ—Ç—É –∏ —É—á–∞—Å—Ç–≤—É–π –≤ –∫–æ–Ω–∫—É—Ä—Å–µ!\n–ü—Ä–æ–π—Ç–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å üëá\nhttps://vk.com/app54435997";
        vkBridge.send('VKWebAppShowWallPostBox', {
          message,
          attachments: document.getElementById('result-img').src
        }).catch(console.error);
      }
    }

    const style = document.createElement('style');
    style.textContent = `@keyframes spin { to { transform: rotate(360deg); } }`;
    document.head.appendChild(style);
  </script>
</body>
</html>