<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ê–Ω–∫–µ—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/@vkontakte/vk-bridge@2.12.0/dist/vk-bridge.umd.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      overflow-x: hidden;
    }
    .screen {
      display: none;
      width: 100vw;
      height: 100vh;
    }
    .active { display: block; }

    .illustration-container,
    .illustration-container-prefull {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: white;
    }
    .illustration,
    .illustration-prefull {
      width: 100%;
      max-width: 1080px;
      height: auto;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    @font-face {
      font-family: 'InputFont';
      src: url('/static/fonts/Blogger_Sans-Light_Italic.otf') format('opentype');
      font-display: swap;
    }
    @font-face {
      font-family: 'BloggerSans';
      src: url('/static/fonts/Blogger_Sans-Light.otf') format('opentype');
      font-display: swap;
    }

    .input-field {
      position: absolute;
      left: 175px;
      top: 745px;
      width: 750px;
      min-height: 60px;
      max-height: 134px;
      padding: 0 10px;
      font-family: 'InputFont', cursive;
      font-size: 35px;
      font-weight: 300;
      font-style: normal;
      color: #555555;
      text-align: left;
      border: none;
      outline: none;
      background: transparent;
      border-radius: 12px;
      resize: none;
      overflow: hidden;
      z-index: 15;
      line-height: 67px;
      word-break: break-word;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .char-counter {
      position: absolute;
      top: 707px;
      right: 155px;
      font-family: 'SF Pro Text', 'Segoe UI', sans-serif;
      font-size: 12px;
      font-weight: 300;
      color: rgba(51, 51, 51, 0.5);
      z-index: 16;
    }

    .action-btn {
      position: absolute;
      left: 45px;
      width: 990px;
      height: 171px;
      border-radius: 76px;
      font-family: 'BloggerSans', 'Segoe UI', sans-serif;
      font-size: 71px;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 20;
      display: flex;
      justify-content: center;
      align-items: center;
      border: none;
      outline: none;
      background: transparent;
      text-align: center;
      padding: 0 20px;
      box-sizing: border-box;
    }

    .action-btn:active {
      transform: translateY(4px);
      box-shadow: 0 4px 4px rgba(0, 0, 0, 0.2);
    }

    #welcome .action-btn { bottom: 135px; background: linear-gradient(135deg, #93AE00, #C7DD4C); color: #FFFFFF; box-shadow: 0 8px 8px rgba(0, 0, 0, 0.25); }
    #q1 .action-btn { bottom: 135px; background: linear-gradient(135deg, #FD5DA2, #CD2F61); color: #FFFFFF; box-shadow: 0 8px 8px rgba(0, 0, 0, 0.25); }
    #q2-prev, #q3-prev, #q4-prev, #q5-prev, #q6-prev, #q7-prev, #q8-prev { bottom: 135px; background: #FFFFFF; color: #52524F; box-shadow: none; }
    #q2-next, #q3-next, #q4-next, #q5-next, #q6-next, #q7-next, #q8-next { bottom: 338px; background: linear-gradient(135deg, #BAA0F3, #6E47C5); color: #FFFFFF; box-shadow: 0 8px 8px rgba(0, 0, 0, 0.25); }
    #q3-next { background: linear-gradient(135deg, #93AE00, #C7DD4C); }
    #q4-next { background: linear-gradient(135deg, #FD5DA2, #CD2F61); }
    #q5-next { background: linear-gradient(135deg, #BAA0F3, #6E47C5); }
    #q6-next { background: linear-gradient(135deg, #93AE00, #C7DD4C); }
    #q7-next { background: linear-gradient(135deg, #FD5DA2, #CD2F61); }
    #q8-next { background: linear-gradient(135deg, #BAA0F3, #6E47C5); }
    #prefull-btn { bottom: 200px; background: linear-gradient(135deg, #FD5DA2, #CD2F61); color: #FFFFFF; box-shadow: 0 8px 8px rgba(0, 0, 0, 0.25); }
    #result-screen .action-btn { bottom: 327px; background: linear-gradient(135deg, #FD5DA2, #CD2F61); color: #FFFFFF; box-shadow: 0 8px 8px rgba(0, 0, 0, 0.25); }
  </style>
</head>
<body>
  <div id="welcome" class="screen active">
    <div class="illustration-container">
      <img src="/static/images/welcome.jpg" class="illustration">
      <button class="action-btn" id="start-btn">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É</button>
    </div>
  </div>

  <div id="q1" class="screen">
    <div class="illustration-container">
      <img src="/static/images/q1.jpg" class="illustration">
      <div id="name" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="name-counter">0/76</div>
      <button class="action-btn" id="q1-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q2" class="screen">
    <div class="illustration-container">
      <img src="/static/images/q2.jpg" class="illustration">
      <div id="city" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="city-counter">0/76</div>
      <button class="action-btn" id="q2-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q2-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q3" class="screen">
    <div class="illustration-container">
      <img src="/static/images/q3.jpg" class="illustration">
      <div id="dream" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="dream-counter">0/76</div>
      <button class="action-btn" id="q3-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q3-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q4" class="screen">
    <div class="illustration-container">
      <img src="/static/images/q4.jpg" class="illustration">
      <div id="age" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="age-counter">0/76</div>
      <button class="action-btn" id="q4-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q4-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q5" class="screen">
    <div class="illustration-container">
      <img src="/static/images/q5.jpg" class="illustration">
      <div id="hobby" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="hobby-counter">0/76</div>
      <button class="action-btn" id="q5-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q5-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q6" class="screen">
    <div class="illustration-container">
      <img src="/static/images/q6.jpg" class="illustration">
      <div id="goal" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="goal-counter">0/76</div>
      <button class="action-btn" id="q6-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q6-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q7" class="screen">
    <div class="illustration-container">
      <img src="/static/images/q7.jpg" class="illustration">
      <div id="quote" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="quote-counter">0/76</div>
      <button class="action-btn" id="q7-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q7-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q8" class="screen">
    <div class="illustration-container">
      <img src="/static/images/q8.jpg" class="illustration">
      <div id="extra" class="input-field" contenteditable="true"></div>
      <div class="char-counter" id="extra-counter">0/76</div>
      <button class="action-btn" id="q8-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q8-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="prefull" class="screen">
    <div class="illustration-container-prefull">
      <img src="/static/images/prefull.jpg" class="illustration-prefull">
      <button class="action-btn" id="prefull-btn">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
    </div>
  </div>

  <div id="result-screen" class="screen">
    <div style="padding: 20px; text-align: center;">
      <img id="result-img" style="width:100%; max-width:600px; border-radius:16px; margin:20px 0;">
      <button class="action-btn" id="share-btn">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –ø–æ–¥—Ä—É–∂–∫–∞–º–∏!</button>
    </div>
  </div>

  <script>
    let currentScreen = 'welcome';
    let userId = null;
    let platform = 'web';
    const TELEGRAM_BOT_NAME = "your_bot";
    const MAX_LEN = 76;

    if (window.location.search.includes('vk_app_id')) {
      platform = 'vk';
      vkBridge.send('VKWebAppInit');
      vkBridge.send('VKWebAppGetUserInfo').then(data => userId = data.id);
    } else if (window.Telegram?.WebApp) {
      platform = 'telegram';
      const initData = Telegram.WebApp.initDataUnsafe;
      userId = initData?.user?.id;
      Telegram.WebApp.ready();
    }

    function getText(el) { return el.innerText || el.textContent || ''; }
    function setText(el, text) { el.innerText = text; }

    const STORAGE_KEY = 'quiz_answers_v15';
    function saveAnswer(field, value) {
      const current = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      current[field] = value;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(current));
    }

    function loadAnswers() {
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      ['name','city','dream','age','hobby','goal','quote','extra'].forEach(id => {
        const el = document.getElementById(id);
        const counter = document.getElementById(`${id}-counter`);
        if (el && saved[id]) {
          setText(el, saved[id]);
          counter.textContent = `${saved[id].length}/${MAX_LEN}`;
        }
      });
    }

    function clearAnswers() {
      localStorage.removeItem(STORAGE_KEY);
    }

    document.addEventListener('DOMContentLoaded', loadAnswers);

    function setupInputLimit(div, counterId, maxLen = MAX_LEN) {
      div.addEventListener('keydown', (e) => {
        const isSpecialKey = ['Backspace','Delete','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Tab','Escape','Enter','Control','Meta','Alt'].includes(e.key);
        if (isSpecialKey) return;
        const text = getText(div);
        const key = e.key;
        if (text.length >= 4) {
          const last4 = text.slice(-4);
          if (/^(.)\1{3}$/.test(last4) && key === last4[0]) {
            e.preventDefault(); return false;
          }
        }
        if (text.length >= maxLen) {
          e.preventDefault(); return false;
        }
      });
      div.addEventListener('input', () => {
        const text = getText(div);
        document.getElementById(counterId).textContent = `${text.length}/${maxLen}`;
        saveAnswer(div.id, text);
      });
    }

    ['name','city','dream','age','hobby','goal','quote','extra'].forEach(id => {
      const el = document.getElementById(id);
      const counterId = `${id}-counter`;
      if (el) {
        setupInputLimit(el, counterId, MAX_LEN);
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        if (saved[id]) {
          setText(el, saved[id]);
          document.getElementById(counterId).textContent = `${saved[id].length}/${MAX_LEN}`;
        }
      }
    });

    function show(screenId) {
      document.getElementById(currentScreen).classList.remove('active');
      document.getElementById(screenId).classList.add('active');
      currentScreen = screenId;
    }

    document.getElementById('start-btn').onclick = () => show('q1');
    document.getElementById('q1-next').onclick = () => show('q2');
    document.getElementById('q2-prev').onclick = () => show('q1');
    document.getElementById('q2-next').onclick = () => show('q3');
    document.getElementById('q3-prev').onclick = () => show('q2');
    document.getElementById('q3-next').onclick = () => show('q4');
    document.getElementById('q4-prev').onclick = () => show('q3');
    document.getElementById('q4-next').onclick = () => show('q5');
    document.getElementById('q5-prev').onclick = () => show('q4');
    document.getElementById('q5-next').onclick = () => show('q6');
    document.getElementById('q6-prev').onclick = () => show('q5');
    document.getElementById('q6-next').onclick = () => show('q7');
    document.getElementById('q7-prev').onclick = () => show('q6');
    document.getElementById('q7-next').onclick = () => show('q8');
    document.getElementById('q8-prev').onclick = () => show('q7');
    document.getElementById('q8-next').onclick = () => show('prefull');
    document.getElementById('prefull-btn').onclick = () => submitForm();
    document.getElementById('share-btn').onclick = () => shareResult();

    async function submitForm() {
      const btn = document.getElementById('prefull-btn');
      const originalText = btn.textContent.trim();

      if (!document.getElementById('spinner-style')) {
        const style = document.createElement('style');
        style.id = 'spinner-style';
        style.textContent = `@keyframes spin { to { transform: rotate(360deg); } }`;
        document.head.appendChild(style);
      }

      btn.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:center; width:100%; height:100%;">
          <span>${originalText}</span>
          <span id="spinner" style="
            display:inline-block;
            width:48px;
            height:48px;
            border:4px solid #fff;
            border-top-color:transparent;
            border-radius:50%;
            animation:spin 1s linear infinite;
            margin-left:26px;
            margin-top:4px;
          "></span>
        </div>
      `;

      try {
        const answers = {
          name: getText(document.getElementById('name')) || '',
          city: getText(document.getElementById('city')) || '',
          dream: getText(document.getElementById('dream')) || '',
          age: getText(document.getElementById('age')) || '',
          hobby: getText(document.getElementById('hobby')) || '',
          goal: getText(document.getElementById('goal')) || '',
          quote: getText(document.getElementById('quote')) || '',
          extra: getText(document.getElementById('extra')) || ''
        };

        const res = await fetch('/generate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ user_id: userId, platform, answers })
        });

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        document.getElementById('result-img').src = url;
        show('result-screen');
        clearAnswers();
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞:", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
        btn.innerHTML = originalText;
      }
    }

    async function shareResult() {
      const imgUrl = document.getElementById('result-img').src;
      if (platform === 'vk') {
        const message = "–ó–∞–ø–æ–ª–Ω–∏ –∞–Ω–∫–µ—Ç—É –∏ —É—á–∞—Å—Ç–≤—É–π –≤ –∫–æ–Ω–∫—É—Ä—Å–µ!\n–ü—Ä–æ–π—Ç–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å üëá\nhttps://vk.com/app1234567";
        vkBridge.send('VKWebAppShowWallPostBox', { message, attachments: imgUrl });
      } else if (platform === 'telegram') {
        alert(`‚ú® –¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –≤ —á–∞—Ç–µ —Å @${TELEGRAM_BOT_NAME}!\n\nüëâ –ù–∞–∂–º–∏ ¬´–ü–µ—Ä–µ—Å–ª–∞—Ç—å¬ª –∏ –æ—Ç–ø—Ä–∞–≤—å –ø–æ–¥—Ä—É–∂–∫–∞–º!\n\n–£—á–∞—Å—Ç–≤—É–π –≤ –∫–æ–Ω–∫—É—Ä—Å–µ!`);
      }
    }
  </script>
</body>
</html>