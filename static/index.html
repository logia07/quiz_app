<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ê–Ω–∫–µ—Ç–∞ ¬´–ú–µ–∂–¥—É –Ω–∞–º–∏ –¥–µ–≤–æ—á–∫–∞–º–∏¬ª</title>

  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
  <meta name="theme-color" content="#EDFD97">
  <meta name="format-detection" content="telephone=no">

  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>

  <script>
    if (window.vkBridge) {
      vkBridge.send('VKWebAppInit')
        .catch(err => console.error('VK Bridge –æ—à–∏–±–∫–∞:', err));
    }
  </script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      font-family: sans-serif;
      background: #f9f9f9;
      overflow-x: hidden;
      overflow-y: auto;
      width: 100%;
      height: 100%;
      position: relative;
      -webkit-overflow-scrolling: touch;
    }

    .screen {
      display: none;
      width: 100%;
      height: 100%;
      min-height: -webkit-fill-available;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
    }

    .active { display: block; }

    #welcome { background-color: #EDFD97; }
    #q1 { background-color: #FBC2D6; }
    #q2 { background-color: #D7C9F6; }
    #q3 { background-color: #EDFD97; }
    #q4 { background-color: #FBC2D6; }
    #q5 { background-color: #D7C9F6; }
    #q6 { background-color: #EDFD97; }
    #q7 { background-color: #FBC2D6; }
    #q8 { background-color: #D7C9F6; }
    #prefull { background-color: #EDFD97; }
    #result-screen { background-color: #EDFD97; }

    .quiz-container {
      position: relative;
      width: 100%;
      max-width: 1080px;
      aspect-ratio: 1080 / 1920;
      margin: 0 auto;
    }

    .prefull-container {
      position: relative;
      width: 100%;
      max-width: 1080px;
      aspect-ratio: 1080 / 2624;
      margin: 0 auto;
    }

    .result-container {
      position: relative;
      width: 100%;
      max-width: 1080px;
      aspect-ratio: 1080 / 4830;
      margin: 0 auto;
    }

    .illustration {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      pointer-events: none;
      -webkit-user-drag: none;
    }

    @font-face {
      font-family: 'InputFont';
      src: url('static/fonts/Blogger_Sans-Light.otf') format('opentype');
      font-display: swap;
    }
    @font-face {
      font-family: 'BloggerSans';
      src: url('static/fonts/Blogger_Sans-Light.otf') format('opentype');
      font-display: swap;
    }

    .input-field {
      position: absolute;
      left: 16.2%;
      top: 38.8%;
      width: 69.4%;
      height: 130px;
      box-sizing: border-box;
      padding: 0px;
      font-family: 'InputFont', sans-serif;
      font-size: clamp(14px, 3.5vmin, 37px);
      line-height: 1.8;
      color: #555;
      text-align: left;
      border: none;
      outline: none;
      background: transparent;
      border-radius: 12px;
      resize: none;
      overflow: hidden;
      z-index: 15;
      word-break: break-word;
      white-space: pre-wrap;
      -webkit-user-select: text;
      user-select: text;
      -webkit-touch-callout: default;
      touch-action: manipulation;
      cursor: text;
      font-size: 16px;
      caret-color: #000 !important;
      -webkit-text-fill-color: #555;
    }

    .input-field:focus {
      background: rgba(255, 255, 255, 0.1);
    }

    .char-counter {
      position: absolute;
      top: 36.8%;
      right: 14.4%;
      font-family: 'SF Pro Text', sans-serif;
      font-size: clamp(10px, 2vmin, 12px);
      color: rgba(51, 51, 51, 0.5);
      z-index: 16;
      pointer-events: none;
    }

    .action-btn {
      position: absolute;
      left: 4.2%;
      width: 91.7%;
      aspect-ratio: 990 / 171;
      min-height: 50px;
      max-height: 171px;
      border-radius: 76px;
      font-family: 'BloggerSans', sans-serif;
      font-size: clamp(20px, 5vw, 71px);
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      border: none;
      outline: none;
      background: transparent;
      text-align: center;
      padding: 0 20px;
      box-shadow: 0 8px 8px rgba(0, 0, 0, 0.25);
      z-index: 20;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
    }

    .action-btn.pressed {
      transform: translateY(4px) scale(0.985);
      opacity: 0.92;
      box-shadow: 0 4px 4px rgba(0, 0, 0, 0.2);
    }

    #welcome .action-btn { bottom: 7.0%; background: linear-gradient(135deg, #93AE00, #C7DD4C); color: #FFFFFF; }
    #q1 .action-btn { bottom: 7.0%; background: linear-gradient(135deg, #FD5DA2, #CD2F61); color: #FFFFFF; }
    #q2-prev, #q3-prev, #q4-prev, #q5-prev, #q6-prev, #q7-prev, #q8-prev {
      bottom: 7.0%; background: #FFFFFF; color: #52524F; box-shadow: none;
    }
    #q2-next, #q3-next, #q4-next, #q5-next, #q6-next, #q7-next, #q8-next {
      bottom: 17.6%; background: linear-gradient(135deg, #BAA0F3, #6E47C5); color: #FFFFFF;
    }
    #q3-next { background: linear-gradient(135deg, #93AE00, #C7DD4C); }
    #q4-next { background: linear-gradient(135deg, #FD5DA2, #CD2F61); }
    #q5-next { background: linear-gradient(135deg, #BAA0F3, #6E47C5); }
    #q6-next { background: linear-gradient(135deg, #93AE00, #C7DD4C); }
    #q7-next { background: linear-gradient(135deg, #FD5DA2, #CD2F61); }
    #q8-next { background: linear-gradient(135deg, #BAA0F3, #6E47C5); }

    #prefull-btn {
      position: absolute;
      left: 4.2%;
      width: 91.7%;
      aspect-ratio: 990 / 171;
      min-height: 50px;
      max-height: 171px;
      bottom: 7.6%;
      border-radius: 76px;
      font-family: 'BloggerSans', sans-serif;
      font-size: clamp(20px, 5vw, 71px);
      background: linear-gradient(135deg, #FD5DA2, #CD2F61);
      color: #FFFFFF;
      cursor: pointer;
      box-shadow: 0 8px 8px rgba(0, 0, 0, 0.25);
      display: flex;
      justify-content: center;
      align-items: center;
      border: none;
      outline: none;
      text-align: center;
      padding: 0 20px;
    }

    #prefull-btn.pressed {
      transform: translateY(4px) scale(0.985);
      opacity: 0.92;
      box-shadow: 0 4px 4px rgba(0, 0, 0, 0.2);
    }

    #result-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 16px;
    }

    #share-btn {
      position: absolute;
      left: 4.2%;
      width: 91.7%;
      aspect-ratio: 990 / 171;
      min-height: 50px;
      max-height: 171px;
      bottom: 10.9%;
      border-radius: 76px;
      font-family: 'BloggerSans', sans-serif;
      font-size: clamp(20px, 5vw, 71px);
      background: linear-gradient(135deg, #FD5DA2, #CD2F61);
      color: #FFFFFF;
      cursor: pointer;
      box-shadow: 0 8px 8px rgba(0, 0, 0, 0.25);
      border: none;
      outline: none;
      text-align: center;
      padding: 0 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 30;
    }

    #share-btn.pressed {
      transform: translateY(4px) scale(0.985);
      opacity: 0.92;
      box-shadow: 0 4px 4px rgba(0, 0, 0, 0.2);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #EDFD97;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #loading.hidden {
      display: none;
    }
    #loading .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #93AE00;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <div id="welcome" class="screen active">
    <div class="quiz-container">
      <img src="static/images/welcome.jpg" class="illustration">
      <button class="action-btn" id="start-btn">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É</button>
    </div>
  </div>

  <div id="q1" class="screen">
    <div class="quiz-container">
      <img src="static/images/q1.jpg" class="illustration">
      <textarea id="name" class="input-field" maxlength="72"></textarea>
      <div class="char-counter" id="name-counter">0/72</div>
      <button class="action-btn" id="q1-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q2" class="screen">
    <div class="quiz-container">
      <img src="static/images/q2.jpg" class="illustration">
      <textarea id="city" class="input-field" maxlength="72"></textarea>
      <div class="char-counter" id="city-counter">0/72</div>
      <button class="action-btn" id="q2-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q2-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q3" class="screen">
    <div class="quiz-container">
      <img src="static/images/q3.jpg" class="illustration">
      <textarea id="dream" class="input-field" maxlength="72"></textarea>
      <div class="char-counter" id="dream-counter">0/72</div>
      <button class="action-btn" id="q3-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q3-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q4" class="screen">
    <div class="quiz-container">
      <img src="static/images/q4.jpg" class="illustration">
      <textarea id="age" class="input-field" maxlength="72"></textarea>
      <div class="char-counter" id="age-counter">0/72</div>
      <button class="action-btn" id="q4-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q4-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q5" class="screen">
    <div class="quiz-container">
      <img src="static/images/q5.jpg" class="illustration">
      <textarea id="hobby" class="input-field" maxlength="72"></textarea>
      <div class="char-counter" id="hobby-counter">0/72</div>
      <button class="action-btn" id="q5-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q5-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q6" class="screen">
    <div class="quiz-container">
      <img src="static/images/q6.jpg" class="illustration">
      <textarea id="goal" class="input-field" maxlength="72"></textarea>
      <div class="char-counter" id="goal-counter">0/72</div>
      <button class="action-btn" id="q6-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q6-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q7" class="screen">
    <div class="quiz-container">
      <img src="static/images/q7.jpg" class="illustration">
      <textarea id="quote" class="input-field" maxlength="72"></textarea>
      <div class="char-counter" id="quote-counter">0/72</div>
      <button class="action-btn" id="q7-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q7-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="q8" class="screen">
    <div class="quiz-container">
      <img src="static/images/q8.jpg" class="illustration">
      <textarea id="extra" class="input-field" maxlength="72"></textarea>
      <div class="char-counter" id="extra-counter">0/72</div>
      <button class="action-btn" id="q8-prev">–Ω–∞–∑–∞–¥</button>
      <button class="action-btn" id="q8-next">–≤–ø–µ—Ä–µ–¥</button>
    </div>
  </div>

  <div id="prefull" class="screen">
    <div class="prefull-container">
      <img src="static/images/prefull.jpg" class="illustration">
      <button class="action-btn" id="prefull-btn">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
    </div>
  </div>

  <div id="result-screen" class="screen">
    <div class="result-container">
      <img id="result-img" src="" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç –ê–Ω–∫–µ—Ç—ã">
      <button class="action-btn" id="share-btn">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –ø–æ–¥—Ä—É–∂–∫–∞–º–∏!</button>
    </div>
  </div>

  <script>
    let userId = null;
    let platform = 'web';
    let resultPublicUrl = null;
    const MAX_LEN = 72;
    const MAX_LINES = 2;
    const MAX_CHARS_LINE_1 = 36;
    const MAX_CHARS_LINE_2_IF_30_PLUS = 36;
    const STORAGE_KEY = 'quiz_answers_v15';

    // =====================================================================
    // –ó–ê–ì–†–£–ó–ö–ê TELEGRAM –°–ö–†–ò–ü–¢–ê
    // =====================================================================
    async function loadTelegramScript() {
      if (window.Telegram) return true;

      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://telegram.org/js/telegram-web-app.js';
        script.onload = () => resolve(true);
        script.onerror = () => reject(new Error('Telegram script failed'));
        document.head.appendChild(script);
      });
    }

    // =====================================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–õ–ê–¢–§–û–†–ú–´
    // =====================================================================
    async function initPlatform() {
      const loading = document.getElementById('loading');

      try {
        const urlParams = new URLSearchParams(window.location.search);
        const vkAppId = urlParams.get('vk_app_id');

        if (vkAppId) {
          platform = 'vk';
          userId = urlParams.get('vk_user_id');

          if (window.vkBridge) {
            vkBridge.send('VKWebAppSetViewSettings', {
              status_bar_style: 'light',
              action_bar_color: '#EDFD97'
            });

            vkBridge.subscribe('VKWebAppBackButton', () => {
              const welcome = document.getElementById('welcome');
              if (welcome.classList.contains('active')) {
                vkBridge.send('VKWebAppExitApp');
              } else {
                show('welcome');
              }
            });
          }

          if (loading) loading.classList.add('hidden');
          return;
        }

        const isTelegram = window.Telegram?.WebApp ||
                          (window.location.hash.includes('tgWebAppData')) ||
                          navigator.userAgent.includes('Telegram');

        if (isTelegram) {
          try {
            await loadTelegramScript();

            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            userId = Telegram.WebApp.initDataUnsafe?.user?.id;
            platform = 'telegram';

            if (loading) loading.classList.add('hidden');
            return;
          } catch (e) {
            // Telegram –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
          }
        }
      } catch (e) {
        // –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      } finally {
        if (loading) loading.classList.add('hidden');
      }
    }

    // =====================================================================
    // –°–û–•–†–ê–ù–ï–ù–ò–ï –û–¢–í–ï–¢–û–í
    // =====================================================================
    function saveAnswer(field, value) {
      const current = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      current[field] = value;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(current));
    }

    function loadAnswers() {
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      ['name','city','dream','age','hobby','goal','quote','extra'].forEach(id => {
        const el = document.getElementById(id);
        const counter = document.getElementById(`${id}-counter`);
        if (el && saved[id]) {
          el.value = saved[id];
          counter.textContent = `${saved[id].length}/${MAX_LEN}`;
        }
      });
    }

    function clearAnswers() {
      localStorage.removeItem(STORAGE_KEY);
    }

    // =====================================================================
    // üî¥ –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –í–í–û–î–ê + –ë–õ–û–ö–ò–†–û–í–ö–ê ENTER
    // =====================================================================
    function setupInputLimit(input, counterId, maxLen = MAX_LEN) {
      // üî¥ –ë–õ–û–ö–ò–†–û–í–ö–ê ENTER ‚Äî –Ω–µ –¥–∞—ë–º —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          return false;
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
      input.addEventListener('input', () => {
        let text = input.value;
        const counter = document.getElementById(counterId);
        const lines = text.split('\n');

        if (lines.length >= 1 && lines[0].length > MAX_CHARS_LINE_1) {
          lines[0] = lines[0].slice(0, MAX_CHARS_LINE_1);
        }

        const maxLine2 = lines.length > 0 && lines[0].length >= 30
          ? MAX_CHARS_LINE_2_IF_30_PLUS
          : MAX_CHARS_LINE_1;

        if (lines.length >= 2 && lines[1].length > maxLine2) {
          lines[1] = lines[1].slice(0, maxLine2);
        }

        if (lines.length > MAX_LINES) {
          text = lines.slice(0, MAX_LINES).join('\n');
          input.value = text;
          if (counter) counter.textContent = `${text.length}/${MAX_LEN}`;
          saveAnswer(input.id, text);
          return;
        }

        if (text.length > maxLen) {
          text = text.slice(0, maxLen);
          input.value = text;
          if (counter) counter.textContent = `${maxLen}/${MAX_LEN}`;
          saveAnswer(input.id, text);
          return;
        }

        if (counter) counter.textContent = `${text.length}/${MAX_LEN}`;
        saveAnswer(input.id, text);
      });
    }

    // =====================================================================
    // –ê–î–ê–ü–¢–ê–¶–ò–Ø –®–†–ò–§–¢–û–í
    // =====================================================================
    function updateInputFontSizes() {
      const containers = document.querySelectorAll('.quiz-container, .prefull-container, .result-container');
      containers.forEach(container => {
        const containerWidth = container.offsetWidth;
        if (!containerWidth) return;

        const scaleFactor = containerWidth / 1080;

        container.querySelectorAll('.input-field').forEach(field => {
          const baseSize = 37;
          const newSize = baseSize * scaleFactor;
          const finalSize = Math.max(14, Math.min(37, newSize));
          field.style.fontSize = `${finalSize}px`;
          field.style.lineHeight = '1.8';
          const paddingTop = 5 * scaleFactor;
          field.style.paddingTop = `${paddingTop}px`;
        });

        container.querySelectorAll('.char-counter').forEach(counter => {
          const baseSize = 12;
          const newSize = baseSize * scaleFactor;
          const finalSize = Math.max(10, Math.min(12, newSize));
          counter.style.fontSize = `${finalSize}px`;
        });

        container.querySelectorAll('.action-btn').forEach(btn => {
          const baseSize = 71;
          const newSize = baseSize * scaleFactor;
          const finalSize = Math.max(20, Math.min(71, newSize));
          btn.style.fontSize = `${finalSize}px`;
        });
      });
    }

    function show(screenId) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      setTimeout(updateInputFontSizes, 50);
    }

    // =====================================================================
    // –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö
    // =====================================================================
    function setupButton(id, onClick) {
      const btn = document.getElementById(id);
      if (!btn) return;

      const press = (e) => {
        e?.preventDefault();
        btn.classList.add('pressed');
      };
      const release = (e) => {
        e?.preventDefault();
        btn.classList.remove('pressed');
        onClick();
      };

      btn.addEventListener('touchstart', press, { passive: false });
      btn.addEventListener('touchend', release, { passive: false });
      btn.addEventListener('touchcancel', () => btn.classList.remove('pressed'));

      btn.addEventListener('mousedown', press);
      btn.addEventListener('mouseup', release);
      btn.addEventListener('mouseleave', () => btn.classList.remove('pressed'));
    }

    // =====================================================================
    // üî¥ SHARE ‚Äî –ï–î–ò–ù–ê–Ø –ú–ï–•–ê–ù–ò–ö–ê –î–õ–Ø –í–°–ï–• –ü–õ–ê–¢–§–û–†–ú
    // =====================================================================
    function shareResult() {
      if (!resultPublicUrl) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç!');
        return;
      }

      const previewUrl = window.location.origin + '/preview' + resultPublicUrl.replace('/r/', '/');

      const vkMiniAppUrl = 'https://vk.com/app54460400';
      const telegramBotUrl = 'https://t.me/Sloboda8Marta_bot';

      const shareText = `–ü—Ä–∏–≤–µ—Ç, –ø–æ–¥—Ä—É–∂–∫–∞ üå∏ –ú–æ—è –∞–Ω–∫–µ—Ç–∞ —Å –æ—Ç–≤–µ—Ç–∞–º–∏ —É–∂–µ –≥–æ—Ç–æ–≤–∞!
–ó–∞–ø–æ–ª–Ω—è–π —Å–≤–æ—é –≤ ${platform === 'vk' ? vkMiniAppUrl : telegramBotUrl} –∏ –ø–µ—Ä–µ–¥–∞–≤–∞–π –ø–æ–¥—Ä—É–≥–∞–º üí´
–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Å—è –Ω–∞ https://t.me/sloboda_russia –∏ —É—á–∞—Å—Ç–≤—É–π –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ –ø—Ä–∏–∑–æ–≤! üíù`;

      try {
        // TELEGRAM ‚Äî –Ω–∞—Ç–∏–≤–Ω—ã–π share
        if (platform === 'telegram') {
          Telegram.WebApp.openTelegramLink(
            `https://t.me/share/url?url=${encodeURIComponent(previewUrl)}&text=${encodeURIComponent(shareText)}`
          );
        }
        // VK ‚Äî –í–°–ï –ü–õ–ê–¢–§–û–†–ú–´ —á–µ—Ä–µ–∑ vk.com/share.php (—Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –º–æ–¥–µ—Ä–∞—Ü–∏–∏)
        else if (platform === 'vk') {
          const shareUrl = `https://vk.com/share.php?url=${encodeURIComponent(previewUrl)}&title=${encodeURIComponent(shareText)}`;

          // Desktop ‚Äî –Ω–æ–≤–æ–µ –æ–∫–Ω–æ popup
          if (window.innerWidth >= 1024) {
            window.open(shareUrl, '_blank', 'width=600,height=400');
          }
          // Mobile (iOS + Android) ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –≤ —Ç–æ–º –∂–µ –æ–∫–Ω–µ
          else {
            window.location.href = shareUrl;
          }
        }
        // Web / –¥—Ä—É–≥–∏–µ ‚Äî —Ç–∏—Ö–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
        else {
          fallbackShare(previewUrl, shareText);
        }
      } catch (e) {
        fallbackShare(previewUrl, shareText);
      }
    }

    // =====================================================================
    // FALLBACK ‚Äî –¢–ò–•–û–ï –ö–û–ü–ò–†–û–í–ê–ù–ò–ï
    // =====================================================================
    function fallbackShare(url, text) {
      const fullText = `${text}\n\n${url}`;

      const textarea = document.createElement('textarea');
      textarea.value = fullText;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();

      try {
        document.execCommand('copy');
        document.body.removeChild(textarea);
        // –¢–∏—Ö–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      } catch (err) {
        document.body.removeChild(textarea);
        prompt('–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É:', fullText);
      }
    }

    // =====================================================================
    // –ì–ï–ù–ï–†–ê–¶–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–ê
    // =====================================================================
    async function submitForm() {
      const btn = document.getElementById('prefull-btn');
      if (!btn) return;
      const originalText = btn.textContent.trim();
      btn.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%"><span>${originalText}</span><span style="display:inline-block;width:48px;height:48px;border:4px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:26px"></span></div>`;
      btn.style.pointerEvents = 'none';

      const answers = {};
      ['name','city','dream','age','hobby','goal','quote','extra'].forEach(id => {
        answers[id] = document.getElementById(id).value || '';
      });

      try {
        const res = await fetch(window.location.origin + '/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId, platform, answers })
        });
        if (!res.ok) throw new Error('Server error');
        const blob = await res.blob();
        document.getElementById('result-img').src = URL.createObjectURL(blob);
        resultPublicUrl = res.headers.get('x-result-url');
        show('result-screen');
        clearAnswers();
      } catch (e) {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
        btn.innerHTML = originalText;
        btn.style.pointerEvents = 'auto';
      }
    }

    // =====================================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // =====================================================================
    window.addEventListener('DOMContentLoaded', async () => {
      await initPlatform();
      loadAnswers();

      ['name','city','dream','age','hobby','goal','quote','extra'].forEach(id => {
        const el = document.getElementById(id);
        if (el) setupInputLimit(el, `${id}-counter`, MAX_LEN);
      });

      setTimeout(updateInputFontSizes, 150);
      window.addEventListener('resize', updateInputFontSizes);

      setupButton('start-btn', () => show('q1'));
      setupButton('q1-next', () => show('q2'));
      setupButton('q2-prev', () => show('q1'));
      setupButton('q2-next', () => show('q3'));
      setupButton('q3-prev', () => show('q2'));
      setupButton('q3-next', () => show('q4'));
      setupButton('q4-prev', () => show('q3'));
      setupButton('q4-next', () => show('q5'));
      setupButton('q5-prev', () => show('q4'));
      setupButton('q5-next', () => show('q6'));
      setupButton('q6-prev', () => show('q5'));
      setupButton('q6-next', () => show('q7'));
      setupButton('q7-prev', () => show('q6'));
      setupButton('q7-next', () => show('q8'));
      setupButton('q8-prev', () => show('q7'));
      setupButton('q8-next', () => show('prefull'));
      setupButton('prefull-btn', submitForm);
      setupButton('share-btn', shareResult);

      if (platform === 'telegram' && window.Telegram?.WebApp) {
        setTimeout(() => Telegram.WebApp.expand(), 300);
      }

      show('welcome');
    });
  </script>
</body>
</html>